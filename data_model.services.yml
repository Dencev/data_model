services:
  serializer.encoder.json_schema:
    class: Drupal\data_model\Encoder\JsonSchemaEncoder
    tags:
      - { name: encoder, priority: 22, format: 'schema_json' }

  # Assemble Schemas based on entity type definitions. As a standalone class,
  # the SchemaFactory can be pulled in to custom menu routes, drush commands,
  # and REST plugins. The SchemaFactory::create() creates instances of
  # Drupal\data_model\Schema\SchemaInterface.
  data_model.schema_factory:
    class: Drupal\data_model\SchemaFactory
    arguments:
      - @logger.channel.data_model
      - @entity_type.manager
      - @entity_type.bundle.info
      - @typed_data_manager
      - @config.typed

  # Create a log channel for this module. This simplifies logging setup code in
  # this code that will do logging. As a tradeoff, it also adds this fairly
  # specific logging channel to the system for all requests.
  logger.channel.data_model:
    parent: logger.channel_base
    arguments: ['data_model']

  # ----------------------------------------------------------------------------
  # - NORMALIZERS for each format.
  # ----------------------------------------------------------------------------
  # - 1. JSON format.
  # ----------------------------------------------------------------------------

  # References should be converted to other schema resources for the type.
  # This priority ensures the DataReferenceDefinition is handled before
  # DataDefinition. Since it is orthogonal to ComplexDataDefinition, they share
  # the same priority.
  serializer.normalizer.data_reference_definition.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\DataReferenceDefinitionNormalizer
    arguments: ['@entity_type.manager']
    tags:
      - { name: normalizer, priority: 25 }

  # Normalize complex data properties.
  # This priority ensures the ComplexDataDefinition is handled before
  # DataDefinition. Since it is orthagonal to DataReferenceDefinition, they
  # share the same priority.
  serializer.normalizer.complex_data_definition.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\ComplexDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 20 }

  # Field definitions are a variant of List definitions, with additional access
  # to the particular schema and configuration pieces from the field system. As
  # a subclass of ListDataDefinitionInterface, FieldDefinitionInterface needs a
  # higher priority.
  serializer.normalizer.field_definition.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\FieldDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 30 }

  # If the typed data definition is a list (as most are somewhere along the
  # property hierarchy) this triggers the recursion to the next layer.
  serializer.normalizer.list_data_definition.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\ListDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 20 }

  # Typed data definitions in general can take many forms. This handles final items.
  serializer.normalizer.data_definition.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\DataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 10 }

  # This is the main JSON Schema normalizer.
  serializer.normalizer.schema.schema_json.json:
    class: Drupal\data_model\Normalizer\JsonSchema\json\SchemataSchemaNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  # ----------------------------------------------------------------------------
  # - 2. JSON API format.
  # ----------------------------------------------------------------------------
  serializer.normalizer.complex_data_definition.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\ComplexDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 20 }
  serializer.normalizer.field_definition.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\FieldDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 30 }
  serializer.normalizer.relationship_field_definition.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\RelationshipFieldDefinitionNormalizer
    arguments: ['@plugin.manager.field.field_type']
    tags:
      - { name: normalizer, priority: 35 }
  serializer.normalizer.list_data_definition.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\ListDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 20 }
  serializer.normalizer.data_definition.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\DataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  serializer.normalizer.schema.schema_json.jsonapi:
    class: Drupal\data_model\Normalizer\JsonSchema\jsonapi\SchemataSchemaNormalizer
    tags:
      - { name: normalizer, priority: 10 }
  # ----------------------------------------------------------------------------
  # - 3. HAL+JSON format.
  # ----------------------------------------------------------------------------
  # HAL+JSON version of the Data Reference normalizer.
  serializer.normalizer.data_reference_definition.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\DataReferenceDefinitionNormalizer
    arguments: ['@entity_type.manager', '@rest.link_manager']
    tags:
      - { name: normalizer, priority: 30 }

  # Normalize complex data properties for HAL.
  # This services is primarily used to short-circuit merging normalization of
  # data references to the schema root.
  serializer.normalizer.complex_data_definition.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\ComplexDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 25 }

  # HAL version of FieldDefinition.
  # This services is primarily used to short-circuit merging normalization of
  # data references to the schema root.
  serializer.normalizer.field_definition.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\FieldDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 35 }

  # HAL version of the ListDataDefinition.
  # This services is primarily used to short-circuit merging normalization of
  # data references to the schema root.
  serializer.normalizer.list_data_definition.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\ListDataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 25 }
  serializer.normalizer.schema.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\SchemataSchemaNormalizer
    tags:
      - { name: normalizer, priority: 15 }
  serializer.normalizer.data_definition.schema_json.hal_json:
    class: Drupal\data_model\Normalizer\JsonSchema\hal\DataDefinitionNormalizer
    tags:
      - { name: normalizer, priority: 10 }
